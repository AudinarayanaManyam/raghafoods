{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 67, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Downloads/raagafoods%20%282%29/raagafoods/src/app/api/reviews/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { promises as fs } from 'fs';\r\nimport path from 'path';\r\n\r\n// Mark this as a dynamic route - must be at the top\r\nexport const dynamic = 'force-dynamic';\r\nexport const runtime = 'nodejs';\r\n\r\n// Review type interface\r\ninterface ReviewData {\r\n  id: string;\r\n  productId: string;\r\n  userId: string;\r\n  userName: string;\r\n  rating: number;\r\n  title: string;\r\n  content: string;\r\n  location: string | null;\r\n  verifiedPurchase: boolean;\r\n  helpfulVotes: number;\r\n  totalVotes: number;\r\n  createdAt: string;\r\n}\r\n\r\n// Path to the reviews JSON file\r\nfunction getReviewsFilePath(): string {\r\n  return path.join(process.cwd(), 'public', 'data', 'reviews.json');\r\n}\r\n\r\n// Read reviews from JSON file\r\nasync function readReviews(): Promise<ReviewData[]> {\r\n  try {\r\n    const filePath = getReviewsFilePath();\r\n    const fileContent = await fs.readFile(filePath, 'utf-8');\r\n    const data = JSON.parse(fileContent) as { reviews: ReviewData[] };\r\n    return data.reviews || [];\r\n  } catch (error) {\r\n    console.error('[Read Reviews Error]', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n// Write reviews to JSON file\r\nasync function writeReviews(reviews: ReviewData[]) {\r\n  try {\r\n    const filePath = getReviewsFilePath();\r\n    const data = { reviews };\r\n    await fs.writeFile(filePath, JSON.stringify(data, null, 2), 'utf-8');\r\n    console.log('[Write Reviews] Successfully saved to JSON file');\r\n  } catch (error) {\r\n    console.error('[Write Reviews Error]', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\ninterface ReviewPayload {\r\n  productId: string;\r\n  userName: string;\r\n  rating: number;\r\n  title: string;\r\n  content: string;\r\n  userId?: string;\r\n  location?: string;\r\n  verifiedPurchase?: boolean;\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body: ReviewPayload = await request.json();\r\n\r\n    console.log('[POST Review] Received review:', body);\r\n\r\n    // Validation\r\n    const errors: string[] = [];\r\n    if (!body.productId?.trim()) errors.push('Product ID required');\r\n    if (!body.userName?.trim()) errors.push('User name required');\r\n    if (!body.title?.trim()) errors.push('Title required');\r\n    if (!body.content?.trim()) errors.push('Content required');\r\n    if (!body.rating || body.rating < 1 || body.rating > 5) {\r\n      errors.push('Rating must be 1-5');\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      console.log('[POST Review] Validation errors:', errors);\r\n      return NextResponse.json(\r\n        { success: false, errors },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Read existing reviews from JSON file\r\n    const reviews = await readReviews();\r\n\r\n    // Create new review\r\n    const newReview = {\r\n      id: `review_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n      productId: body.productId.trim(),\r\n      userId: body.userId || `user_${Date.now()}`,\r\n      userName: body.userName.trim(),\r\n      rating: body.rating,\r\n      title: body.title.trim(),\r\n      content: body.content.trim(),\r\n      location: body.location?.trim() || null,\r\n      verifiedPurchase: body.verifiedPurchase || false,\r\n      helpfulVotes: 0,\r\n      totalVotes: 0,\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n\r\n    // Add to reviews array\r\n    reviews.push(newReview);\r\n\r\n    // Write back to JSON file\r\n    await writeReviews(reviews);\r\n\r\n    console.log(`[POST Review] Review stored successfully. Total reviews: ${reviews.length}`);\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        message: 'Review submitted successfully',\r\n        review: newReview,\r\n      },\r\n      { status: 201 }\r\n    );\r\n  } catch (error) {\r\n    console.error('[POST Review Error]', error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: 'Failed to submit review',\r\n        message: error instanceof Error ? error.message : 'Unknown error',\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const productId = searchParams.get('productId');\r\n    const sortBy = searchParams.get('sortBy') || 'newest';\r\n    const filterRating = searchParams.get('filterRating');\r\n\r\n    console.log(`[GET Reviews] productId=${productId}, sortBy=${sortBy}, filterRating=${filterRating}`);\r\n\r\n    if (!productId) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Product ID required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Read reviews from JSON file\r\n    const allReviews = await readReviews();\r\n    console.log(`[GET Reviews] Total reviews in file: ${allReviews.length}`);\r\n\r\n    // Get reviews for product\r\n    let reviews: ReviewData[] = allReviews.filter(\r\n      (r: ReviewData) => r.productId === productId\r\n    );\r\n\r\n    console.log(`[GET Reviews] Found ${reviews.length} reviews for product ${productId}`);\r\n\r\n    // Filter by rating\r\n    if (filterRating) {\r\n      const rating = parseInt(filterRating);\r\n      if (!isNaN(rating)) {\r\n        reviews = reviews.filter((r: ReviewData) => r.rating === rating);\r\n      }\r\n    }\r\n\r\n    // Sort\r\n    reviews.sort((a: ReviewData, b: ReviewData) => {\r\n      switch (sortBy) {\r\n        case 'oldest':\r\n          return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();\r\n        case 'highest':\r\n          return b.rating - a.rating;\r\n        case 'lowest':\r\n          return a.rating - b.rating;\r\n        case 'helpful':\r\n          return (b.helpfulVotes / Math.max(b.totalVotes, 1)) -\r\n                 (a.helpfulVotes / Math.max(a.totalVotes, 1));\r\n        case 'newest':\r\n        default:\r\n          return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();\r\n      }\r\n    });\r\n\r\n    // Calculate summary\r\n    const summary = {\r\n      averageRating:\r\n        reviews.length > 0\r\n          ? reviews.reduce((sum: number, r: ReviewData) => sum + r.rating, 0) / reviews.length\r\n          : 0,\r\n      totalReviews: reviews.length,\r\n      ratingBreakdown: {\r\n        1: reviews.filter((r: ReviewData) => r.rating === 1).length,\r\n        2: reviews.filter((r: ReviewData) => r.rating === 2).length,\r\n        3: reviews.filter((r: ReviewData) => r.rating === 3).length,\r\n        4: reviews.filter((r: ReviewData) => r.rating === 4).length,\r\n        5: reviews.filter((r: ReviewData) => r.rating === 5).length,\r\n      },\r\n    };\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        data: {\r\n          reviews,\r\n          summary,\r\n          total: reviews.length,\r\n        },\r\n      },\r\n      { status: 200 }\r\n    );\r\n  } catch (error) {\r\n    console.error('[GET Reviews Error]', error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: 'Failed to fetch reviews',\r\n        message: error instanceof Error ? error.message : 'Unknown error',\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function PUT(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    const { reviewId, productId, isHelpful } = body;\r\n\r\n    if (!reviewId || !productId) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Review ID and Product ID required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Read reviews from JSON file\r\n    const reviews = await readReviews();\r\n\r\n    // Find the review\r\n    const review = reviews.find((r: ReviewData) => r.id === reviewId && r.productId === productId);\r\n\r\n    if (!review) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Review not found' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Update votes\r\n    if (isHelpful) {\r\n      review.helpfulVotes++;\r\n    }\r\n    review.totalVotes++;\r\n\r\n    // Write updated reviews back to JSON file\r\n    await writeReviews(reviews);\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        message: 'Vote recorded',\r\n        review,\r\n      },\r\n      { status: 200 }\r\n    );\r\n  } catch (error) {\r\n    console.error('Vote error:', error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: 'Failed to record vote',\r\n        message: error instanceof Error ? error.message : 'Unknown error',\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}